{% extends "base.html" %}

{% block title %}Threat Intelligence - LureNet{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Threat Intelligence</h1>
    <p class="page-subtitle">Analyze file hashes and URLs using multiple threat intelligence sources</p>
</div>

<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3>Hash Analysis</h3>
        </div>
        <div class="card-body">
            <form id="hash-form">
                <div class="form-group">
                    <label for="hash-input" class="form-label">File Hash (MD5, SHA1, SHA256)</label>
                    <input type="text" id="hash-input" class="form-input" placeholder="Enter file hash..." required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <span>Analyze Hash</span>
                </button>
            </form>
            <div id="hash-result" style="margin-top: 1.5rem;"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>URL Analysis</h3>
        </div>
        <div class="card-body">
            <form id="url-form">
                <div class="form-group">
                    <label for="url-input" class="form-label">URL</label>
                    <input type="text" id="url-input" class="form-input" placeholder="Enter URL..." required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <span>Analyze URL</span>
                </button>
            </form>
            <div id="url-result" style="margin-top: 1.5rem;"></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Threat Intelligence Sources</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 0.5rem;">
                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">MalwareBazaar</h4>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">abuse.ch malware database with file hashes and samples</p>
            </div>
            <div style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 0.5rem;">
                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">ThreatFox</h4>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">Indicators of Compromise (IoCs) sharing platform</p>
            </div>
            <div style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 0.5rem;">
                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">URLhaus</h4>
                <p style="color: var(--text-secondary); font-size: 0.875rem;">Malware URL database and payload information</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.getElementById('hash-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const hash = document.getElementById('hash-input').value.trim();
        const resultDiv = document.getElementById('hash-result');

        resultDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

        try {
            const response = await fetch('/api/intel/hash', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({hash: hash})
            });

            const result = await response.json();
            displayHashResult(result);
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        }
    });

    document.getElementById('url-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const url = document.getElementById('url-input').value.trim();
        const resultDiv = document.getElementById('url-result');

        resultDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

        try {
            const response = await fetch('/api/intel/url', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            });

            const result = await response.json();
            displayUrlResult(result);
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        }
    });

    function displayHashResult(result) {
        const resultDiv = document.getElementById('hash-result');
        let html = '<div style="padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 0.5rem;">';

        html += `<div style="margin-bottom: 1rem;">
            <span class="severity-badge severity-${result.verdict === 'malicious' ? 'critical' : result.verdict === 'suspicious' ? 'high' : 'low'}">
                ${result.verdict.toUpperCase()}
            </span>
            <span style="margin-left: 1rem; color: var(--text-secondary);">Threat Score: ${result.threat_score}/100</span>
        </div>`;

        html += '<div style="margin-bottom: 1rem;">';
        html += `<div><strong>Hash:</strong> <code>${result.hash}</code></div>`;
        html += `<div><strong>Type:</strong> ${result.hash_type.toUpperCase()}</div>`;
        html += '</div>';

        if (result.sources && Object.keys(result.sources).length > 0) {
            html += '<h4 style="margin: 1rem 0 0.5rem;">Sources</h4>';
            for (const [source, data] of Object.entries(result.sources)) {
                if (data && data.found) {
                    html += `<div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.375rem; margin-bottom: 0.5rem;">`;
                    html += `<strong style="color: #fca5a5;">${source}</strong><br>`;
                    if (data.malware) html += `Malware: ${data.malware}<br>`;
                    if (data.threat_type) html += `Threat: ${data.threat_type}<br>`;
                    if (data.first_seen) html += `First Seen: ${data.first_seen}`;
                    html += '</div>';
                }
            }
        } else {
            html += '<div style="color: var(--text-muted); margin-top: 1rem;">No malicious indicators found</div>';
        }

        html += '</div>';
        resultDiv.innerHTML = html;
    }

    function displayUrlResult(result) {
        const resultDiv = document.getElementById('url-result');
        let html = '<div style="padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 0.5rem;">';

        html += `<div style="margin-bottom: 1rem;">
            <span class="severity-badge severity-${result.verdict === 'malicious' ? 'critical' : result.verdict === 'suspicious' ? 'high' : 'low'}">
                ${result.verdict.toUpperCase()}
            </span>
            <span style="margin-left: 1rem; color: var(--text-secondary);">Threat Score: ${result.threat_score}/100</span>
        </div>`;

        html += '<div style="margin-bottom: 1rem;">';
        html += `<div style="word-break: break-all;"><strong>URL:</strong> ${result.url}</div>`;
        html += '</div>';

        if (result.sources && Object.keys(result.sources).length > 0) {
            html += '<h4 style="margin: 1rem 0 0.5rem;">Sources</h4>';
            for (const [source, data] of Object.entries(result.sources)) {
                if (data && data.found) {
                    html += `<div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.375rem; margin-bottom: 0.5rem;">`;
                    html += `<strong style="color: #fca5a5;">${source}</strong><br>`;
                    if (data.threat) html += `Threat: ${data.threat}<br>`;
                    if (data.url_status) html += `Status: ${data.url_status}<br>`;
                    if (data.date_added) html += `Added: ${data.date_added}`;
                    html += '</div>';
                }
            }
        } else {
            html += '<div style="color: var(--text-muted); margin-top: 1rem;">No malicious indicators found</div>';
        }

        html += '</div>';
        resultDiv.innerHTML = html;
    }
</script>
{% endblock %}
